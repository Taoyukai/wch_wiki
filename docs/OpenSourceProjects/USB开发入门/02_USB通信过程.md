---
sidebar_position: 2
description: 介绍 USB 常见术语和 USB 的通信过程
---



# 02_USB 通信过程

USB 是轮询总线，采用一问一答的传输方式，物理传输双方角色一定是主机和设备。

USB 主机与设备之间的数据交换都是由**主机发起**的，设备端只能被动的响应。

一次完整的通信分为三个过程：请求过程（令牌包）、数据过程（数据包）和状态过程（握手包），没有数据要传输时，跳过数据过程。
通信过程包含以下三种情况：

![usb_communication_process](img\usb_communication_process.png)

主机发送令牌包（Token）开始请求过程，如果请求中声明有数据要传输则有数据过程，最后由数据接收方（有数据过程）或从机（无数据过程）发起状态过程，结束本次通信。

- 与USB全速设备通信时，主机将每秒等分为1000个帧（Frame）。主机在每帧开始时，向所有从机广播一个帧起始令牌包（Start Of Frame，SOF包）。它的作用有两个：一是通知所有从机，主机的USB总线正常工作；二是从机以此同步主机的时序。

- 与USB高速设备通信时，主机将帧进一步等分为8个微帧（Microframe），每个微帧占125μs。在同一帧内，8个微帧的帧号都等于当前SOF包的帧号。

## 1. 常见的术语和概念

### 1.1 设备地址（Device Address）

主机管理设备，而为每一个连接的设备分配一个地址，主机最多可以分配 **127** 个设备地址。

### 1.2 上传（IN）/下传（OUT）

USB 主机接收 USB 设备的数据称为**上传（IN）**；

USB 主机发送数据给 USB 设备称为**下传（OUT）**。

### 1.3 端点（Endpoint）

端点是主机与设备之间通讯数据的接收或来源，并且仅存在于 USB 设备中。

主机要给设备发送数据，端点就是数据的接收器，主机要给设备要数据，端点就是数据的发送器。

- 每个端点只能有一个传输方向
- 一个设备最多可以有16 个 OUT 和16 个 IN 端点
- 端点 0 仅用于控制传输，不能分配给任何其他功能

### 1.4 管道（Pipe）

管道分为两种类型：

- 消息管道具有已定义的 USB 格式并受主机控制。消息管道允许数据双向流动并且仅支持控制传输。
- 流管道没有定义的 USB 格式，可以由主机或设备控制。数据流具有预定义的方向，即IN或OUT。流管道支持中断传输、同步传输和批量传输。
    当 USB 设备连接到 USB 总线并由 USB 主机配置时，大多数管道就会存在。管道源自主机客户端内的数据缓冲区，并在 USB 设备内的端点处终止。

![usb_pipe_endpoint](img\usb_pipe_endpoint.png)



## 2. USB 插入检测

USB 主机的 D+ 和D- 分别接了 15K 的下拉电阻到地。当没有设备接入时，D+ 和 D- 都为低电平。

USB 设备端，在D+或者D-上接了1.5K 欧姆上拉电阻至 3.3V。对于全速和高速设备，上拉电阻是接在 D+ 上；而低速设备则是上拉电阻接在 D- 上。这样，当设备接入主机后，由 1.5K 的上拉电阻和 15K 的下拉电阻分压，结果就将差分数据线中的一条拉高到 3V 左右。



![usb_full_or_low_speed_identify](img\usb_full_or_low_speed_identify.png)

## 3. USB 设备速度检测

**USB 低速设备**是在 D- 线上拉 1.5K 电阻。

**USB 全速设备**是在 D+ 线上拉 1.5K 电阻。

**USB高速设备**先是被识别为全速设备，然后通过 HOST 和 DEVICE 两者之间的确认，再切换到高速模式的。在高速模式下，是电流传输模式，这时将 D+上的上拉电阻断开。

## 4. USB 枚举过程

USB 主机检测到 USB 设备插入后，就要对设备进行枚举了。

枚举的作用就是从设备是那个读取一些信息，知道这是个什么样的设备，这样主机就可以根据这些信息安装合适的驱动程序。

枚举过程如下：

1. USB 设备插入后，主机检测 D+/D- 线上的电压，确认有设备连接，USB 集线器通过中断IN通道，向主机报告有 USB 设备连接。
2. 主机接到通知后等待100ms，等设备稳定，对 USB 设备进行复位，复位后 USB 设备的地址为 0，这样主机就可以使用地址 0 与 USB 设备进行通信，复位后的设备可以从USB总线上获取小于100mA的电流，用于使用默认地址对管道 0 控制事务响应。
3. 主机向地址为 0（即刚插入的USB设备）的设备端点 0（默认端点）发送获取设备描述符的标准请求 GetDescriptor。
4. USB 设备收到请求后，将其预设的设备描述符返回给主机。
5. 主机收到设备描述符后，返回一个 0 长度的数据确认包。
6. 主机对设备再次复位，复位后主机对地址为 0 的设备端点 0 发送一个设置地址 SetAddress 请求（新的设备地址在数据包中）。
7. 主机发送请求状态返回，设备返回 0 长度的状态数据包。
8. 主机收到状态数据包后，发送应答包 ACK 给设备，设备收到 ACK 后，启用新的设备地址。
9. 主机再次使新的地址获取设备描述符 GetDescriptor，设备返回地址描述符。
10. 主机获取第一次配置描述符有前 18 个字节，设备返回配置描述符的前 18 个字节，其数据包中含有配置描述符的总长度。
11. 主机根据配置描述符的总长度再次获取配置描述符，设备返回全总的配置描述符。
12. 如果还有字符串描述符，系统还会获取字符串描述符。像 HID 设备还有报告描述符，它也需要单独获取。

各过程的设备状态如下表：（详见 usb_20 手册第九章）

| Attached<br/>插入 | Powered<br/>供电 | Default<br/>初始 | Address<br/>地址 | Configured<br/>配置 | Suspended<br/>挂起 |           State<br/>状态           |
| :---------------: | :--------------: | :--------------: | :--------------: | :-----------------: | :----------------: | :--------------------------------: |
|        No         |        -         |        -         |        -         |          -          |         -          |             设备未插入             |
|        Yes        |        No        |        -         |        -         |          -          |         -          |        设备已插入，但未供电        |
|        Yes        |       Yes        |        No        |        -         |          -          |         -          |      设备已插入供电，但未复位      |
|        Yes        |       Yes        |       Yes        |        No        |          -          |         -          | 设备已插入供电并复位，但未分配地址 |
|        Yes        |       Yes        |       Yes        |       Yes        |         No          |         -          |    设备已分配地址，但未进行配置    |
|        Yes        |       Yes        |       Yes        |       Yes        |         Yes         |         No         |       设备已配置，可正常通信       |
|        Yes        |       Yes        |        -         |        -         |          -          |        Yes         |    总线超过3ms无活动，设备挂起     |

## 5. USB 复位机制（Reset）

主机拉低 D+ 和 D- 信号线保持 10ms 以上，即发出 Reset 复位信号。 USB 设备收到复位信号后，恢复设备进入未配置状态。

## 6. USB 挂起机制（Suspended）

在USB系统中，正常状态下PC，Hub或Root Hub会一直周期性地发送SOF包(Start Of Frame，全速USB每1ms发送一个，高速USB则是125µs发送一个)。根据USB协议，如果USB线上一直处于空闲(Idle)状态超过3ms，设备应该把它当作一个挂起(Suspended)信号，要求设备在10ms内进入挂起状态，并把设备所需的电流大小降到规定的值。

## 7. USB 唤醒机制（Resume）

设备处于挂起状态时，任何总线上的活动（非空闲信号）都可以把设备唤醒/恢复，从而退出低功耗模式。同样，设备也可以换醒host，比如电脑待机时通过USB键盘来换醒主机，这种功能称之为”远程唤醒“。



## 参考

- [USB 2.0 Specification](https://www.usb.org/sites/default/files/usb_20_20211008.zip)

- [USB中文网](https://www.usbzh.com/article/detail-144.html)

- 圈圈教你玩USB
